---
// Staff Dashboard
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width" />
		<title>Staff Control | RedRes</title>
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap" rel="stylesheet">
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			body { font-family: 'Plus Jakarta Sans', sans-serif; }
		</style>
	</head>
	<body class="bg-[#0f172a] text-slate-100 min-h-screen">
		<nav class="bg-[#1e293b] border-b border-slate-800 p-6">
			<div class="max-w-7xl mx-auto flex justify-between items-center">
				<div class="flex items-center gap-4">
					<div class="w-10 h-10 bg-red-600 rounded-xl flex items-center justify-center font-black">R</div>
					<h1 class="text-xl font-bold tracking-tight">Staff Concierge</h1>
				</div>
				<div class="flex items-center gap-6">
					<a href="https://redres.sanity.studio" target="_blank" class="text-sm font-bold text-slate-400 hover:text-white transition-colors">Edit Menu</a>
					<a href="/" class="bg-white/5 hover:bg-white/10 px-4 py-2 rounded-lg text-sm font-bold border border-white/10 transition-all">View Site</a>
				</div>
			</div>
		</nav>

		<main class="max-w-7xl mx-auto px-6 py-12">
			<div class="flex justify-between items-end mb-10">
				<div>
					<h2 class="text-4xl font-black mb-2">Bookings</h2>
					<p class="text-slate-500 font-medium">Real-time reservation management</p>
				</div>
				<div class="flex gap-3">
					<div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700 text-sm font-bold">
						<span class="text-yellow-500" id="pendingCount">0</span> Pending
					</div>
				</div>
			</div>
			
			<div class="bg-[#1e293b] rounded-[2rem] shadow-2xl border border-slate-800 overflow-hidden">
				<div class="overflow-x-auto">
					<table class="w-full text-left border-collapse">
						<thead>
							<tr class="text-[10px] uppercase tracking-[0.2em] text-slate-500 border-b border-slate-800">
								<th class="p-8 font-black">Guest</th>
								<th class="p-8 font-black">Schedule</th>
								<th class="p-8 font-black">Party</th>
								<th class="p-8 font-black">Status</th>
								<th class="p-8 font-black text-right">Control</th>
							</tr>
						</thead>
						<tbody id="bookingsList" class="divide-y divide-slate-800/50">
							<!-- Dynamic content -->
						</tbody>
					</table>
				</div>
				<div id="emptyState" class="hidden p-20 text-center">
					<div class="text-6xl mb-4 opacity-10">ðŸ“­</div>
					<p class="text-slate-500 font-bold">No reservations found yet.</p>
				</div>
			</div>
		</main>

		<script>
			import { supabase } from '../lib/supabase';

			async function updateStatus(id: string, status: string) {
				const { error } = await supabase
					.from('bookings')
					.update({ status })
					.eq('id', id);
				
				if(!error) fetchBookings();
			}

			async function fetchBookings() {
				const { data, error } = await supabase
					.from('bookings')
					.select('*')
					.order('created_at', { ascending: false });

				const list = document.getElementById('bookingsList');
				const empty = document.getElementById('emptyState');
				const pendingEl = document.getElementById('pendingCount');
				
				if (!list || !empty) return;

				if (!data || data.length === 0) {
					list.innerHTML = '';
					empty.classList.remove('hidden');
					return;
				}

				empty.classList.add('hidden');
				const pending = data.filter(b => b.status === 'pending').length;
				if(pendingEl) pendingEl.innerText = pending.toString();

				list.innerHTML = data.map(b => `
					<tr class="group hover:bg-white/[0.02] transition-colors">
						<td class="p-8">
							<div class="font-black text-lg text-white">${b.name}</div>
							<div class="text-sm text-slate-500 font-medium mt-1">${b.phone}</div>
						</td>
						<td class="p-8">
							<div class="text-white font-bold">${new Date(b.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</div>
							<div class="mt-2">
								<span class="text-[10px] uppercase font-black px-2 py-1 rounded bg-red-500/10 text-red-500 border border-red-500/20">${b.slot}</span>
							</div>
						</td>
						<td class="p-8">
							<div class="flex items-center gap-4 text-sm font-bold text-slate-300">
								<div class="flex flex-col items-center">
									<span class="text-white text-lg">${b.adults}</span>
									<span class="text-[9px] uppercase text-slate-500">Adult</span>
								</div>
								<div class="w-[1px] h-8 bg-slate-800"></div>
								<div class="flex flex-col items-center">
									<span class="text-white text-lg">${b.children_7_14 + b.children_1_6}</span>
									<span class="text-[9px] uppercase text-slate-500">Child</span>
								</div>
							</div>
						</td>
						<td class="p-8">
							<span class="px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border ${
								b.status === 'pending' ? 'bg-yellow-500/10 text-yellow-500 border-yellow-500/20' :
								b.status === 'approved' ? 'bg-green-500/10 text-green-500 border-green-500/20' :
								'bg-red-500/10 text-red-500 border-red-500/20'
							}">${b.status}</span>
						</td>
						<td class="p-8 text-right">
							${b.status === 'pending' ? `
								<div class="flex justify-end gap-2">
									<button onclick="window.updateStatus('${b.id}', 'approved')" class="bg-green-600 hover:bg-green-500 text-white p-2 rounded-lg transition-all active:scale-95">
										<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
									</button>
									<button onclick="window.updateStatus('${b.id}', 'denied')" class="bg-slate-700 hover:bg-red-600 text-white p-2 rounded-lg transition-all active:scale-95">
										<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
									</button>
								</div>
							` : `
								<button onclick="window.updateStatus('${b.id}', 'pending')" class="text-xs font-bold text-slate-600 hover:text-slate-400">Reset</button>
							`}
						</td>
					</tr>
				`).join('');
			}

			// Expose to window for inline onclick
			(window as any).updateStatus = updateStatus;
			fetchBookings();
			// Refresh every 30s
			setInterval(fetchBookings, 30000);
		</script>
	</body>
</html>
